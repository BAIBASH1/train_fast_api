# Приложение бронирования отелей

## Основные функции сервиса:

- **Бронирование номеров**: Пользователи могут выбрать и забронировать необходимый тип номера в отеле в необходимые даты.
- **Загрузка изображений**: Возможность загрузки изображений.
- **Поиск по локации**: Реализована функция просмотра доступных для бронирования отелей по заданному местоположению.
- **Логирование и мониторинг**: Реализовано логирование, мониторинг ошибок, сбор метрик и их визуализация.
- **Асинхронные запросы**: Используется асинхронный подход к запросам.
- **Админ панель**: Реализована при помощи SQLAdmin.
- **Гибкость развертывания**: Проект готов как для локального развертывания, так и для работы в Docker-контейнерах.

### Полный функционал

- Кастомная регистрация пользователей.
- Аутентификация реализована с помощью куков и JWT-токена.
- У неаутентифицированных пользователей доступ к API только на уровне чтения.
- Создание объектов разрешено только аутентифицированным пользователям.
- Возможность получения подробной информации о себе.
- Загрузка тестовых данных в БД.
- Возможность забронированить комнату отеля, получить список всех своих бронирований и отменить(удалить) свою бронь.
- Отправка email с подтверждением бронирования пользователю посредством Celery.
- Поиск и получение списка всех отелей по заданным параметрам местоположения на определенную дату.
- Возможность получить список всех отелей без исключения и информацию по каждому из них отдельно.
- Возможность получить список всех доступных для бронирования комнат конкретного отеля на определенную дату.
- Возможность получить список всех типов комнат и информацию по каждой из них отдельно.
- Загрузка файлов с изображениями для отелей и их обработка при загрузке с помощью Celery.
- Возможность просмотра выборки доступных для бронирования отелей по месту локации в виде обычной страницы.
- Возможность администрирования сервиса.
- Версионирование API.
- Кеширование/брокер задач с помощью Redis.
- Логирование посредством кастомного логгера.
- Мониторинг ошибок с помощью Sentry.
- Сбор метрик с помощью Prometheus.
- Визуализация метрик посредством Grafana.
- Возможность развернуть проект в Docker-контейнерах.
- Просмотр ошибок в sentry

### После запуска приложения
#### Локально документация доступна по адресу: <http://localhost:8000/v1/docs/>
#### В контейнерах Docker документация доступна по адресу: <http://localhost:8080/v1/docs/>  

#### Технологии

- Python 3.9
- FastAPI 0.92.0
- fastapi-cache2 0.2.1
- Асинхронность
- Anyio
- Cookies
- SQLAdmin
- JWT
- Alembic
- SQLAlchemy 2.0.4
- Docker
- PostgreSQL
- Asyncpg
- CORS
- Redis 4.5.2
- Celery 5.2.7
- Flower
- Sentry
- Prometheus
- Grafana
- Uvicorn
- Gunicorn

## Запуск приложения локально
1. Создайте и заполните `.env` файл согласно примеру в `.env-example`. Для этого:
   - Создайте базу данных PostgreSQL
   - Скачайте и запустите Redis
   - Зарегистрируйте приложение в google (можно и яндекс) для отправки сообщений smtp (необязательный шаг, просто будет функционал урезан)
   - Зарегистрируйтесь в sentry, создайте проект и внесите ссылку в `SENTRY_LINK` (необязательно)
   - Настройки подключений внесите в `.env`

2. Cоздать и активировать виртуальное окружение:

    Команды для установки виртуального окружения на Mac или Linux:
    
    ```bash
    python3 -m venv env
    source env/bin/activate
    ```
    
    Команды для Windows:
    
    ```bash
    python -m venv venv
    source venv/Scripts/activate
    ```
3. Установить зависимости из файла requirements.txt:
    
    ```bash
    pip install -r requirements.txt
    ```

4. Применить миграции (для конфигурации бд):

    ``` bash
    alembic upgrade head 
    ```

5. Запустить тестирование (для загрузки тестовых данных в БД).
   ```
   pytest
   ```

6. Запустить проект:

    ``` bash
    uvicorn app.main:app --reload   
    ```

7. Запустить Celery & Flower

    Для запуска Celery используется команда  
    ```
    celery --app=app.tasks.celery:celery worker -l INFO -P solo
    ```
    Обратите внимание, что `-P solo` используется только на Windows, так как у Celery есть проблемы с работой на Windows.  
    Для запуска Flower используется команда  
    ```
    celery --app=app.tasks.celery:celery flower
   ```


## Запуск приложения в контейнерах
1. Создайте и заполните `.env-non-dev` файл согласно примеру в `.env-non-dev-example`. Для этого:
   - Зарегистрируйте smtp-приложение в google (можно и яндекс) для отправки сообщений smtp (необязательный шаг, просто будет функционал урезан). Настройки подключений внесите в `.env-non-dev`
   - Внесите остальные переменные (пароли / логины для БД, которая будет создана)
2. Запуск с Docker compose

   Для запуска всех сервисов (БД, Redis, веб-сервер (FastAPI), Celery, Flower, Grafana, Prometheus) необходимо использовать файл docker-compose.yml и команды
   ```
   docker compose up --build
   ```
   Причем флаг `--build` нужно применять, только если вы меняли что-то внутри Dockerfile, то есть меняли логику составления образа или контент, который используется для сборки образа (например, файлы приложения или зависимости).

## Тестирование
Для тестирования используется библиотека pytest. Для запуска необходимо изменить `MODE=TEST` в `.env` файле. (Ну и конечно настроить тестовую бд & redis и внести данные для подключения в `.env` согласно примеры в `.env-example`)

Запуск выполняется командой `pytest -v -s`

## Настройка линтинга и форматирования кода

Этот проект использует следующие инструменты для обеспечения качества кода:
- **black** — автоматическое форматирование кода.
- **flake8** — проверка стиля кода и поиск ошибок.
- **isort** — автоматическое упорядочивание импортов.

## Flower
#### После запуска проекта flower доступен по адресу: <http://localhost:5555/> 

## Grafana
Настроены базовые метрики с которыми можно ознакомиться на ее странице.
#### После запуска проекта Grafana доступна по адресу: <http://localhost:3000/> 

## Prometheus
#### После запуска проекта Prometheus доступна по адресу: <http://localhost:9090/> 

## Sentry
Для мониторинга ошибок необходимо зарегистрироваться в Sentry и добавить ссылку в `.env`-файл: `SENTRY_LINK=<link>`

## Админка

#### После локального запуска проекта Админ-панель доступен по адресу: <http://localhost:8000/admin/>
#### В контейнерах Docker Админ-панель доступен по адресу: <http://localhost:8080/admin/>  

## Описание API
Версия: 1.0.0

Также есть `openapi.json` в корневой директории.

---

## Группы методов

### Auth & Пользователи

#### POST `/v1/auth/login`
Логин пользователя  
Идентификатор операции: login_user_auth_login_post  
Тело запроса (application/json):  
Схема: #/components/schemas/UsersAuthSchema  
Ответы:  
- 200: Успешный ответ (application/json)  
- 422: Ошибка валидации → HTTPValidationError  

#### POST `/v1/auth/register`
Регистрация пользователя  
Идентификатор операции: register_user_auth_register_post  
Тело запроса (application/json):  
Схема: #/components/schemas/UsersAuthSchema  
Ответы:  
- 200: Успешный ответ (application/json)  
- 422: Ошибка валидации → HTTPValidationError  

#### GET `/v1/auth/me`
Получить данные пользователя  
Идентификатор операции: read_user_auth_me_get  
Ответы:  
- 200: Успешный ответ (application/json)  

#### POST `/v1/auth/logout`
Выход из системы  
Идентификатор операции: logout_user_auth_logout_post  
Ответы:  
- 200: Успешный ответ (application/json)  

---

### Бронирование

#### GET `/v1/bookings`
Получить список бронирований  
Идентификатор операции: get_bookings_bookings_get  
Ответы:  
- 200: Успешный ответ → массив объектов BookingsInfoSchema  

#### POST `/v1/bookings`
Добавить бронирование  
Идентификатор операции: add_booking_bookings_post  
Параметры запроса:  
- room_id (query, int, обязательный)  
- date_from (query, date, обязательный)  
- date_to (query, date, обязательный)  

Ответы:  
- 200: Успешный ответ → BookingsSchema  
- 422: Ошибка валидации → HTTPValidationError  

#### DELETE `/v1/bookings`
Удалить бронирование  
Идентификатор операции: delete_bookings_bookings_delete  
Параметры запроса:  
- bookings_id (query, int, обязательный)  

Ответы:  
- 200: Успешный ответ → BookingsSchema  
- 422: Ошибка валидации → HTTPValidationError  

---

### Отели

#### GET `/v1/hotels/id/{hotel_id}`
Получить отель по ID  
Идентификатор операции: get_hotel_hotels_id__hotel_id__get  
Параметры пути:  
- hotel_id (int, обязательный)  

Ответы:  
- 200: Успешный ответ (application/json)  
- 422: Ошибка валидации → HTTPValidationError  

#### GET `/v1/hotels/{location}`
Поиск отелей по локации и датам  
Идентификатор операции: get_hotels_by_location_and_time_hotels__location__get  
Параметры:  
- location (path, string, обязательный)  
- date_from (query, date, обязательный)  
- date_to (query, date, обязательный)  

Ответы:  
- 200: Успешный ответ (application/json)  
- 422: Ошибка валидации → HTTPValidationError  

#### GET `/v1/hotels/{hotel_id}/rooms`
Получить комнаты отеля  
Идентификатор операции: get_hotel_rooms_hotels__hotel_id__rooms__get  
Параметры:  
- hotel_id (path, int, обязательный)  
- date_from (query, date, обязательный)  
- date_to (query, date, обязательный)  

Ответы:  
- 200: Успешный ответ (application/json)  
- 422: Ошибка валидации → HTTPValidationError  

---

### Загрузка картинок

#### POST `/v1/images/hotels`
Добавить изображение отеля  
Идентификатор операции: add_hotel_image_images_hotels_post  
Параметры запроса:  
- name (query, int, обязательный)  
Тело запроса (multipart/form-data):  
Схема: Body_add_hotel_image_images_hotels_post

Ответы:  
- 200: Успешный ответ (application/json)  
- 422: Ошибка валидации → HTTPValidationError

___

### Фронтенд

#### GET `/v1/pages/hotels`
Страница отелей  
Идентификатор операции: get_hotels_page_pages_hotels_get  
Параметры запроса:  
- location (string, обязательный)  
- date_from (date, обязательный)  
- date_to (date, обязательный)  

Ответы:  
- 200: Успешный ответ (application/json)  
- 422: Ошибка валидации → HTTPValidationError  

---
